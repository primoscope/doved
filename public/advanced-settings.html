<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EchoTune AI - Advanced Settings</title>
    <style>
        :root {
            --primary-color: #1db954;
            --primary-dark: #1ed760;
            --secondary-color: #191414;
            --background-dark: #121212;
            --background-light: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --error-color: #e22134;
            --success-color: #1db954;
            --warning-color: #f39c12;
            --border-radius: 12px;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--background-dark) 0%, var(--secondary-color) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .nav-link {
            display: inline-block;
            color: var(--primary-color);
            text-decoration: none;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .header h1 {
            color: var(--primary-color);
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .section {
            background: var(--background-light);
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            color: var(--primary-color);
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .parameter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .parameter-control {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
        }

        .parameter-label {
            color: var(--text-primary);
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .parameter-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .slider-container {
            position: relative;
            margin-bottom: 10px;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            cursor: pointer;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: none;
        }

        .slider-value {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .current-value {
            color: var(--primary-color);
            font-weight: bold;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-weight: bold;
        }

        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: var(--background-dark);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(29, 185, 84, 0.1);
        }

        .textarea-large {
            min-height: 120px;
            resize: vertical;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
        }

        .button:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .button.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .button.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .button.danger {
            background: var(--error-color);
        }

        .preset-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .preset-button {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .preset-button:hover, .preset-button.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-indicator.online {
            background: rgba(29, 185, 84, 0.2);
            color: var(--success-color);
        }

        .status-indicator.warning {
            background: rgba(243, 156, 18, 0.2);
            color: var(--warning-color);
        }

        .model-info-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .model-name {
            color: var(--primary-color);
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .model-specs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .spec-item {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
        }

        .spec-value {
            color: var(--primary-color);
            font-size: 1.1rem;
            font-weight: bold;
        }

        .spec-label {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-top: 4px;
        }

        .export-import-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .export-card, .import-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 20px;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .file-input-wrapper:hover .file-input-button {
            border-color: var(--primary-color);
            background: rgba(29, 185, 84, 0.1);
            color: var(--primary-color);
        }

        @media (max-width: 1024px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .parameter-grid {
                grid-template-columns: 1fr;
            }
            
            .export-import-section {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .preset-buttons {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/settings.html" class="nav-link">‚Üê Back to Main Settings</a>
            <h1>üéõÔ∏è Advanced AI Configuration</h1>
            <p>Fine-tune model parameters, customize prompts, and manage your AI settings</p>
        </div>

        <div class="settings-grid">
            <!-- Model Parameters Section -->
            <div class="section">
                <div class="section-title">
                    üéõÔ∏è Model Parameters
                </div>
                
                <div class="model-info-card" id="currentModelInfo">
                    <div class="model-name" id="selectedModelName">Loading...</div>
                    <div class="model-description" id="selectedModelDescription">Please select a model to see its specifications</div>
                    <div class="model-specs" id="selectedModelSpecs">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <div class="preset-buttons" id="parameterPresets">
                    <div class="preset-button active" onclick="applyPreset('balanced')">‚öñÔ∏è Balanced</div>
                    <div class="preset-button" onclick="applyPreset('creative')">üé® Creative</div>
                    <div class="preset-button" onclick="applyPreset('precise')">üéØ Precise</div>
                    <div class="preset-button" onclick="applyPreset('conversation')">üí¨ Conversational</div>
                </div>

                <div class="parameter-grid">
                    <div class="parameter-control">
                        <div class="parameter-label">
                            üå°Ô∏è Temperature
                            <span class="status-indicator online" id="tempStatus">0.7</span>
                        </div>
                        <div class="parameter-description">
                            Controls randomness in responses. Higher values (0.8-1.0) make output more creative, lower values (0.1-0.3) make it more focused.
                        </div>
                        <div class="slider-container">
                            <input type="range" id="temperatureSlider" class="slider" min="0" max="2" step="0.1" value="0.7">
                            <div class="slider-value">
                                <span>0.0 (Focused)</span>
                                <span class="current-value" id="temperatureValue">0.7</span>
                                <span>2.0 (Creative)</span>
                            </div>
                        </div>
                    </div>

                    <div class="parameter-control">
                        <div class="parameter-label">
                            üìè Max Tokens
                            <span class="status-indicator online" id="tokensStatus">2048</span>
                        </div>
                        <div class="parameter-description">
                            Maximum length of the response. Higher values allow for longer, more detailed responses.
                        </div>
                        <div class="slider-container">
                            <input type="range" id="maxTokensSlider" class="slider" min="50" max="4096" step="50" value="2048">
                            <div class="slider-value">
                                <span>50 (Short)</span>
                                <span class="current-value" id="maxTokensValue">2048</span>
                                <span>4096 (Long)</span>
                            </div>
                        </div>
                    </div>

                    <div class="parameter-control">
                        <div class="parameter-label">
                            üéØ Top-P
                            <span class="status-indicator online" id="topPStatus">0.9</span>
                        </div>
                        <div class="parameter-description">
                            Nucleus sampling parameter. Controls the diversity of word choices. Lower values focus on more likely words.
                        </div>
                        <div class="slider-container">
                            <input type="range" id="topPSlider" class="slider" min="0" max="1" step="0.05" value="0.9">
                            <div class="slider-value">
                                <span>0.0 (Narrow)</span>
                                <span class="current-value" id="topPValue">0.9</span>
                                <span>1.0 (Diverse)</span>
                            </div>
                        </div>
                    </div>

                    <div class="parameter-control">
                        <div class="parameter-label">
                            üîÅ Frequency Penalty
                            <span class="status-indicator online" id="freqPenaltyStatus">0.0</span>
                        </div>
                        <div class="parameter-description">
                            Reduces repetition by penalizing frequently used tokens. Positive values encourage diverse vocabulary.
                        </div>
                        <div class="slider-container">
                            <input type="range" id="frequencyPenaltySlider" class="slider" min="-2" max="2" step="0.1" value="0.0">
                            <div class="slider-value">
                                <span>-2.0 (Repeat)</span>
                                <span class="current-value" id="frequencyPenaltyValue">0.0</span>
                                <span>2.0 (Diverse)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="button" onclick="saveModelParameters()">üíæ Save Parameters</button>
                    <button class="button secondary" onclick="resetToDefaults()">üîÑ Reset to Defaults</button>
                    <button class="button secondary" onclick="testCurrentSettings()">üß™ Test Settings</button>
                </div>
            </div>

            <!-- System Prompt Section -->
            <div class="section">
                <div class="section-title">
                    üìù System Prompt Configuration
                </div>
                
                <div class="preset-buttons" id="promptPresets">
                    <div class="preset-button active" onclick="applyPromptPreset('music_assistant')">üéµ Music Assistant</div>
                    <div class="preset-button" onclick="applyPromptPreset('music_expert')">üéì Music Expert</div>
                    <div class="preset-button" onclick="applyPromptPreset('dj_companion')">üéß DJ Companion</div>
                    <div class="preset-button" onclick="applyPromptPreset('casual_friend')">üòä Casual Friend</div>
                </div>

                <div class="input-group">
                    <label for="systemPrompt">System Prompt</label>
                    <textarea id="systemPrompt" class="textarea-large" placeholder="Enter your custom system prompt here...">You are EchoTune AI, a knowledgeable and enthusiastic music assistant. You help users discover new music, create playlists, analyze their listening habits, and find perfect songs for any mood or activity. You have deep knowledge of music across all genres, eras, and cultures. Always be helpful, creative, and passionate about music while maintaining a friendly and approachable tone.</textarea>
                </div>

                <div class="input-group">
                    <label for="conversationContext">Conversation Context Length</label>
                    <select id="conversationContext">
                        <option value="5">Short (5 messages)</option>
                        <option value="10" selected>Medium (10 messages)</option>
                        <option value="20">Long (20 messages)</option>
                        <option value="50">Extended (50 messages)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="responseStyle">Response Style</label>
                    <select id="responseStyle">
                        <option value="concise">Concise & Direct</option>
                        <option value="detailed" selected>Detailed & Informative</option>
                        <option value="creative">Creative & Expressive</option>
                        <option value="technical">Technical & Precise</option>
                    </select>
                </div>

                <div class="button-group">
                    <button class="button" onclick="savePromptSettings()">üíæ Save Prompt</button>
                    <button class="button secondary" onclick="previewPrompt()">üëÅÔ∏è Preview</button>
                </div>
            </div>
        </div>

        <!-- Conversation Management Section -->
        <div class="section">
            <div class="section-title">
                üí¨ Conversation Management
            </div>
            
            <div class="export-import-section">
                <div class="export-card">
                    <h3 style="color: var(--primary-color); margin-bottom: 15px;">üì§ Export Settings</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">Export your current configuration for backup or sharing</p>
                    <div class="button-group">
                        <button class="button" onclick="exportSettings('json')">üìÑ Export JSON</button>
                        <button class="button secondary" onclick="exportSettings('txt')">üìù Export Text</button>
                    </div>
                </div>

                <div class="import-card">
                    <h3 style="color: var(--primary-color); margin-bottom: 15px;">üì• Import Settings</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">Import previously saved configuration</p>
                    <div class="file-input-wrapper">
                        <input type="file" id="importFile" class="file-input" accept=".json,.txt" onchange="importSettings()">
                        <div class="file-input-button">
                            <span>üìÅ</span>
                            <span>Choose File to Import</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-group" style="margin-top: 20px;">
                <label for="conversationHistory">Conversation History Management</label>
                <div class="button-group">
                    <button class="button secondary" onclick="exportConversationHistory()">üìã Export History</button>
                    <button class="button secondary" onclick="clearConversationHistory()">üóëÔ∏è Clear History</button>
                    <button class="button danger" onclick="deleteAllData()">‚ö†Ô∏è Delete All Data</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class AdvancedSettingsManager {
            constructor() {
                this.currentSettings = {
                    temperature: 0.7,
                    maxTokens: 2048,
                    topP: 0.9,
                    frequencyPenalty: 0.0,
                    systemPrompt: '',
                    conversationContext: 10,
                    responseStyle: 'detailed'
                };
                
                this.presets = {
                    balanced: { temperature: 0.7, maxTokens: 2048, topP: 0.9, frequencyPenalty: 0.0 },
                    creative: { temperature: 1.2, maxTokens: 3000, topP: 0.95, frequencyPenalty: 0.3 },
                    precise: { temperature: 0.2, maxTokens: 1500, topP: 0.7, frequencyPenalty: 0.1 },
                    conversation: { temperature: 0.8, maxTokens: 2500, topP: 0.85, frequencyPenalty: 0.2 }
                };

                this.promptPresets = {
                    music_assistant: "You are EchoTune AI, a knowledgeable and enthusiastic music assistant. You help users discover new music, create playlists, analyze their listening habits, and find perfect songs for any mood or activity. You have deep knowledge of music across all genres, eras, and cultures. Always be helpful, creative, and passionate about music while maintaining a friendly and approachable tone.",
                    music_expert: "You are a highly knowledgeable music expert and critic with deep understanding of music theory, history, and cultural significance. Provide detailed, analytical responses about music with technical accuracy while remaining accessible to users of all knowledge levels.",
                    dj_companion: "You are a skilled DJ and music curator with expertise in reading crowds, understanding energy flows, and creating perfect musical journeys. Help users create dynamic playlists, understand mixing techniques, and discover tracks that flow seamlessly together.",
                    casual_friend: "You are a music-loving friend who's always excited to share new discoveries and chat about favorite songs. Keep responses conversational, fun, and relatable while sharing your genuine enthusiasm for music."
                };

                this.initialize();
            }

            initialize() {
                this.loadSavedSettings();
                this.setupEventListeners();
                this.updateUI();
                this.loadCurrentModel();
            }

            setupEventListeners() {
                // Parameter sliders
                document.getElementById('temperatureSlider').addEventListener('input', (e) => {
                    this.updateParameter('temperature', parseFloat(e.target.value));
                });

                document.getElementById('maxTokensSlider').addEventListener('input', (e) => {
                    this.updateParameter('maxTokens', parseInt(e.target.value));
                });

                document.getElementById('topPSlider').addEventListener('input', (e) => {
                    this.updateParameter('topP', parseFloat(e.target.value));
                });

                document.getElementById('frequencyPenaltySlider').addEventListener('input', (e) => {
                    this.updateParameter('frequencyPenalty', parseFloat(e.target.value));
                });

                // Prompt settings
                document.getElementById('systemPrompt').addEventListener('change', (e) => {
                    this.currentSettings.systemPrompt = e.target.value;
                });

                document.getElementById('conversationContext').addEventListener('change', (e) => {
                    this.currentSettings.conversationContext = parseInt(e.target.value);
                });

                document.getElementById('responseStyle').addEventListener('change', (e) => {
                    this.currentSettings.responseStyle = e.target.value;
                });
            }

            updateParameter(param, value) {
                this.currentSettings[param] = value;
                this.updateUI();
            }

            updateUI() {
                // Update sliders
                document.getElementById('temperatureSlider').value = this.currentSettings.temperature;
                document.getElementById('temperatureValue').textContent = this.currentSettings.temperature.toFixed(1);
                document.getElementById('tempStatus').textContent = this.currentSettings.temperature.toFixed(1);

                document.getElementById('maxTokensSlider').value = this.currentSettings.maxTokens;
                document.getElementById('maxTokensValue').textContent = this.currentSettings.maxTokens;
                document.getElementById('tokensStatus').textContent = this.currentSettings.maxTokens;

                document.getElementById('topPSlider').value = this.currentSettings.topP;
                document.getElementById('topPValue').textContent = this.currentSettings.topP.toFixed(2);
                document.getElementById('topPStatus').textContent = this.currentSettings.topP.toFixed(2);

                document.getElementById('frequencyPenaltySlider').value = this.currentSettings.frequencyPenalty;
                document.getElementById('frequencyPenaltyValue').textContent = this.currentSettings.frequencyPenalty.toFixed(1);
                document.getElementById('freqPenaltyStatus').textContent = this.currentSettings.frequencyPenalty.toFixed(1);

                // Update form elements
                document.getElementById('systemPrompt').value = this.currentSettings.systemPrompt;
                document.getElementById('conversationContext').value = this.currentSettings.conversationContext;
                document.getElementById('responseStyle').value = this.currentSettings.responseStyle;
            }

            async loadCurrentModel() {
                try {
                    // Get current model from localStorage or API
                    const savedModel = localStorage.getItem('echotune_selected_model');
                    const savedProvider = localStorage.getItem('echotune_selected_provider');
                    
                    if (savedModel && savedProvider) {
                        const response = await fetch(`/api/providers/providers/${savedProvider}/models`);
                        const data = await response.json();
                        
                        if (data.success) {
                            const model = data.models.find(m => m.id === savedModel);
                            if (model) {
                                this.displayModelInfo(model, savedProvider);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error loading current model:', error);
                }
            }

            displayModelInfo(model, provider) {
                document.getElementById('selectedModelName').textContent = model.name;
                document.getElementById('selectedModelDescription').textContent = model.description;
                
                const specsContainer = document.getElementById('selectedModelSpecs');
                specsContainer.innerHTML = `
                    <div class="spec-item">
                        <div class="spec-value">${model.maxTokens?.toLocaleString() || 'N/A'}</div>
                        <div class="spec-label">Max Tokens</div>
                    </div>
                    <div class="spec-item">
                        <div class="spec-value">${model.contextWindow?.toLocaleString() || 'N/A'}</div>
                        <div class="spec-label">Context Window</div>
                    </div>
                    <div class="spec-item">
                        <div class="spec-value">${model.features?.length || 0}</div>
                        <div class="spec-label">Features</div>
                    </div>
                    <div class="spec-item">
                        <div class="spec-value">${provider}</div>
                        <div class="spec-label">Provider</div>
                    </div>
                `;
            }

            loadSavedSettings() {
                const saved = localStorage.getItem('echotune_advanced_settings');
                if (saved) {
                    try {
                        this.currentSettings = { ...this.currentSettings, ...JSON.parse(saved) };
                    } catch (error) {
                        console.error('Error loading saved settings:', error);
                    }
                }
            }

            saveSettings() {
                localStorage.setItem('echotune_advanced_settings', JSON.stringify(this.currentSettings));
            }
        }

        // Global functions
        function applyPreset(presetName) {
            const manager = window.advancedSettingsManager;
            const preset = manager.presets[presetName];
            
            if (preset) {
                Object.assign(manager.currentSettings, preset);
                manager.updateUI();
                
                // Update active preset button
                document.querySelectorAll('#parameterPresets .preset-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
            }
        }

        function applyPromptPreset(presetName) {
            const manager = window.advancedSettingsManager;
            const prompt = manager.promptPresets[presetName];
            
            if (prompt) {
                manager.currentSettings.systemPrompt = prompt;
                document.getElementById('systemPrompt').value = prompt;
                
                // Update active preset button
                document.querySelectorAll('#promptPresets .preset-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
            }
        }

        function saveModelParameters() {
            const manager = window.advancedSettingsManager;
            manager.saveSettings();
            alert('Model parameters saved successfully!');
        }

        function savePromptSettings() {
            const manager = window.advancedSettingsManager;
            manager.saveSettings();
            alert('Prompt settings saved successfully!');
        }

        function resetToDefaults() {
            if (confirm('Reset all parameters to default values?')) {
                const manager = window.advancedSettingsManager;
                Object.assign(manager.currentSettings, manager.presets.balanced);
                manager.updateUI();
            }
        }

        async function testCurrentSettings() {
            const manager = window.advancedSettingsManager;
            
            try {
                const response = await fetch('/api/chat/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: 'This is a test message to verify the current model parameters are working correctly.',
                        ...manager.currentSettings
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Test successful! Response: ${result.response.substring(0, 100)}...`);
                } else {
                    alert(`Test failed: ${result.message || 'Unknown error'}`);
                }
            } catch (error) {
                alert(`Test failed: ${error.message}`);
            }
        }

        function previewPrompt() {
            const prompt = document.getElementById('systemPrompt').value;
            alert(`Current System Prompt:\n\n${prompt}`);
        }

        function exportSettings(format) {
            const manager = window.advancedSettingsManager;
            const settings = manager.currentSettings;
            
            let content, filename;
            
            if (format === 'json') {
                content = JSON.stringify(settings, null, 2);
                filename = 'echotune-settings.json';
            } else {
                content = Object.entries(settings).map(([key, value]) => 
                    `${key}: ${typeof value === 'string' ? value : JSON.stringify(value)}`
                ).join('\n');
                filename = 'echotune-settings.txt';
            }
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importSettings() {
            const file = document.getElementById('importFile').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    let settings;
                    
                    if (file.name.endsWith('.json')) {
                        settings = JSON.parse(content);
                    } else {
                        // Parse text format
                        settings = {};
                        content.split('\n').forEach(line => {
                            const [key, ...valueParts] = line.split(':');
                            if (key && valueParts.length) {
                                const value = valueParts.join(':').trim();
                                try {
                                    settings[key.trim()] = JSON.parse(value);
                                } catch {
                                    settings[key.trim()] = value;
                                }
                            }
                        });
                    }
                    
                    const manager = window.advancedSettingsManager;
                    Object.assign(manager.currentSettings, settings);
                    manager.updateUI();
                    manager.saveSettings();
                    
                    alert('Settings imported successfully!');
                } catch (error) {
                    alert(`Failed to import settings: ${error.message}`);
                }
            };
            reader.readAsText(file);
        }

        function exportConversationHistory() {
            alert('Conversation history export functionality will be implemented soon!');
        }

        function clearConversationHistory() {
            if (confirm('Clear all conversation history? This action cannot be undone.')) {
                localStorage.removeItem('echotune_conversation_history');
                alert('Conversation history cleared!');
            }
        }

        function deleteAllData() {
            if (confirm('Delete ALL EchoTune data including settings, history, and preferences? This action cannot be undone.')) {
                const keys = Object.keys(localStorage).filter(key => key.startsWith('echotune_'));
                keys.forEach(key => localStorage.removeItem(key));
                alert('All data deleted! The page will reload with default settings.');
                location.reload();
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.advancedSettingsManager = new AdvancedSettingsManager();
        });
    </script>
</body>
</html>