[SERVICE]
    # Fluent Bit configuration for EchoTune AI log aggregation
    Flush         5
    Daemon        off
    Log_Level     info
    Parsers_File  parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020

[INPUT]
    Name              tail
    Path              /app/logs/*.log
    Parser            json
    Tag               app.*
    Refresh_Interval  5
    Skip_Long_Lines   On
    DB                /tmp/fluent-bit-app.db

[INPUT]
    Name              tail
    Path              /nginx/logs/*.log
    Parser            nginx
    Tag               nginx.*
    Refresh_Interval  5
    Skip_Long_Lines   On
    DB                /tmp/fluent-bit-nginx.db

[FILTER]
    Name    modify
    Match   app.*
    Add     service echotune-ai
    Add     environment ${NODE_ENV}
    Add     hostname ${HOSTNAME}

[FILTER]
    Name    modify
    Match   nginx.*
    Add     service nginx
    Add     environment ${NODE_ENV}
    Add     hostname ${HOSTNAME}

[FILTER]
    Name         grep
    Match        app.*
    Regex        level (ERROR|WARN|FATAL|error|warn|fatal)

[OUTPUT]
    Name  stdout
    Match *
    Format json_lines

[OUTPUT]
    Name                forward
    Match               *
    Host                ${FLUENT_FORWARD_HOST}
    Port                ${FLUENT_FORWARD_PORT}
    Require_ack_response true
    # Only if external log aggregation is configured

# Parsers configuration
[PARSER]
    Name        json
    Format      json
    Time_Key    timestamp
    Time_Format %Y-%m-%dT%H:%M:%S.%L
    Time_Keep   On

[PARSER]
    Name        nginx
    Format      regex
    Regex       ^(?<remote>[^ ]*) (?<host>[^ ]*) (?<user>[^ ]*) \[(?<time>[^\]]*)\] "(?<method>\S+)(?: +(?<path>[^\"]*?)(?: +\S*)?)?" (?<code>[^ ]*) (?<size>[^ ]*)(?: "(?<referer>[^\"]*)" "(?<agent>[^\"]*)")?$
    Time_Key    time
    Time_Format %d/%b/%Y:%H:%M:%S %z